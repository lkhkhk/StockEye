# StocksEye 개발 계획 및 현황

## 🚀 최우선 과제: 아키텍처 재설계 및 안정화

> **현황:** E2E 테스트 과정에서 `api`와 `bot` 서비스 간의 순환 의존성으로 인한 심각한 네트워크 오류 및 기능 미작동 문제가 발견되었습니다. 이를 해결하기 위해 Message Queue(Redis)를 도입하고, 비동기 작업을 처리하는 별도의 `worker` 서비스를 추가하는 것으로 아키텍처를 재설계하기로 결정했습니다.

> **목표:** 새로운 아키텍처를 성공적으로 도입하여 서비스 간 결합도를 낮추고, 시스템 전체의 안정성과 확장성을 확보합니다. 이 과정에서 기존의 핵심 기능 미작동 버그들을 모두 해결하고, 안정적인 E2E 테스트를 구축합니다.

### Phase 1: 아키텍처 재설계 및 인프라 구축 (진행 중)

-   [ ] **[인프라] `docker-compose.yml` 수정:**
    -   [x] **(완료)** `redis` 서비스를 신규 추가합니다.
    -   [ ] `worker` 서비스를 신규 추가합니다. (`src/worker` 디렉토리 및 Dockerfile 생성 필요)
    -   [ ] 모든 서비스(`api`, `bot`, `db`, `redis`, `worker`)의 이름과 `container_name`에 `stockseye-` 접두사를 붙여 명명 규칙을 통일합니다. (예: `stockseye-api`)
    -   [ ] 서비스 간 통신에 사용되는 호스트 이름을 새로운 서비스명으로 업데이트합니다. (예: `API_HOST=stockseye-api`)

-   [ ] **[리팩토링] 서비스명 변경에 따른 프로젝트 전체 수정:**
    -   **목표:** `docker-compose.yml`의 서비스명 변경사항을 프로젝트 내의 모든 관련 파일에 일괄 적용합니다.
    -   **대상 파일:**
        -   `dev_ops.sh`, `scripts/service_control.sh` 등 쉘 스크립트
        -   `src/bot/tests/e2e/test_api_bot_e2e.py` 등 테스트 코드 내의 URL
        -   기타 설정 파일 및 문서

### Phase 2: Worker 서비스 구현 및 기능 이전

-   [ ] **[신규] `worker` 서비스 기본 구현:**
    -   `src/worker/main.py`를 생성하고, Redis Pub/Sub 구독 및 메시지 처리를 위한 기본 로직을 구현합니다.
    -   과거 `OLD-PJT/StockEye/app/core/database.py`의 `redis.asyncio` 사용법을 참고하여 비동기 Redis 클라이언트를 구현합니다.

-   [ ] **[기능 이전] 스케줄러 기능 이전:**
    -   `api` 서비스의 `main.py`에 있던 APScheduler 관련 코드를 `worker` 서비스로 이전합니다.
    -   `update_stock_masters`, `update_daily_prices` 등 모든 주기적인 잡(job)이 `worker`에서 실행되도록 수정합니다.

-   [ ] **[기능 이전] 알림 기능 리팩토링:**
    -   **`api` 서비스:** `price_alert_service.py` 등에서 `bot`을 직접 호출하던 로직을 제거하고, `chat_id`와 메시지 내용을 포함한 데이터를 Redis의 `notifications` 채널에 발행(Publish)하도록 수정합니다.
    -   **`worker` 서비스:** `notifications` 채널을 구독하고, 메시지를 수신하면 Telegram API를 직접 호출하여 사용자에게 알림을 발송하는 기능을 구현합니다.

### Phase 3: 핵심 기능 정상화 및 E2E 테스트 구축

> **목표:** 새로운 아키텍처 위에서 기존의 모든 버그를 해결하고, 각 기능에 대한 E2E 테스트를 작성하여 안정성을 검증합니다.

-   [ ] **[버그/치명적] 사용자 데이터 연동 기능 정상화:**
    -   **대상:** `alert`, `history`, `trade`, `watchlist` 등
    -   **해결 방안:** `telegram_id` 기반의 사용자 식별 로직을 `api` 서비스에 중앙화하여 구현했던 내용을 새로운 아키텍처에 맞게 재검증하고 안정화합니다.
    -   **검증:** 각 기능에 대한 **Bot-API-Worker 연동 E2E 테스트 코드를 반드시 작성**하여 버그 재발을 방지합니다.

-   [ ] **[버그/심각] `natural` 핸들러 API 응답 형식 불일치 문제 해결:**
    -   **해결:** `natural.py`에서 API 응답(`{"items": [...]}`)을 올바르게 파싱하도록 수정합니다.
    -   **검증:** E2E 테스트를 통해 자연어 처리 기능의 정상 동작을 확인합니다.

-   [ ] **[기능 누락] 예측 이력 저장을 위한 `user_id` 전달:**
    -   **해결:** `predict`, `natural` 핸들러에서 `/predict` API 호출 시 `telegram_id`를 포함하도록 수정하고, `api`는 이를 `user_id`로 변환하여 이력을 저장하도록 합니다.
    -   **검증:** E2E 테스트를 통해 예측 이력이 DB에 정상적으로 저장되는지 확인합니다.

## 🌟 Phase 4: 테스트 고도화 및 지침 개선 (유지)

-   [ ] **(기존) 단위 테스트 커버리지 100% 달성**
    -   [ ] **Bot 핸들러:** `start.py`, `history.py` 등 누락된 단위 테스트를 작성합니다.
    -   [ ] **API 라우터:** `admin.py` 등 단위 테스트가 없는 모든 라우터에 대해 신규 작성합니다.
    -   [ ] **API 서비스:** `stock_service.py` 등 기존 테스트를 보강하고 순수 단위 테스트로 리팩토링합니다.
    -   [ ] **`common` 모듈:** 모든 공통 모듈에 대한 단위 테스트를 작성합니다.
-   [ ] **(기존) 통합 테스트 보강**
    -   [ ] `predict.py` 등 통합 테스트가 없는 API 라우터에 대해 신규 작성합니다.