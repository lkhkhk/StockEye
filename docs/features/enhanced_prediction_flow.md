# 프로젝트: 예측 기능 흐름 개선

## 1. 목표
`/predict` 명령어의 사용자 경험을 개선합니다. 예측에 필요한 과거 데이터가 부족할 경우, 사용자에게 상황을 안내하고 데이터 다운로드 및 예측 재실행 여부를 선택하게 합니다. 사용자가 동의하면 데이터 업데이트부터 예측 재실행까지의 과정을 자동으로 처리하여 최종 결과를 제공합니다.

## 2. 구성 요소 및 로직 흐름

1.  **`predict_handler` (in `predict.py`)**
    *   **트리거:** 사용자가 `/predict <종목명>` 실행
    *   **동작:** `stockeye-api`의 `/predict` 엔드포인트 호출
    *   **로직:**
        *   **성공 시:** 예측 결과를 사용자에게 표시합니다.
        *   **데이터 부족 시:** "데이터가 부족하여 예측을 할 수 없습니다. 과거 시세를 다운로드하고 다시 예측할까요?" 라는 메시지와 함께 `[예, 실행]`, `[아니오]` 버튼을 사용자에게 보냅니다.

2.  **`predict_callback_handler` (in `predict.py`)**
    *   **트리거:** 사용자가 `[예, 실행]` 또는 `[아니오]` 버튼 클릭
    *   **로직:**
        *   **`[예, 실행]` 클릭 시:**
            1.  기존 메시지를 "과거 시세 데이터 다운로드를 요청했습니다. 완료되면 자동으로 예측을 실행합니다."로 수정합니다.
            2.  `context.user_data['pending_prediction'] = <종목명>` 형태로 상태를 저장하여, 해당 사용자가 데이터 업데이트 후 예측을 기다리고 있음을 기록합니다.
            3.  `stockeye-worker`의 비동기 데이터 수집 작업을 시작하기 위해 `/admin/update_historical_prices` API를 호출합니다.
        *   **`[아니오]` 클릭 시:**
            1.  기존 메시지를 "취소되었습니다."로 수정합니다.

3.  **`notification_handler` (in `main.py` 또는 신규 핸들러)**
    *   **트리거:** 봇이 수신하는 모든 메시지
    *   **로직:**
        1.  메시지가 봇 자신으로부터 온 것인지, 그리고 "✅ **과거 일별 시세 갱신 (...)** 작업 완료" 형태의 작업 완료 알림인지 확인합니다.
        2.  두 조건이 모두 참이면, `context.user_data`에 `pending_prediction` 상태가 있는지 확인합니다.
        3.  상태가 존재하면, 저장된 종목명으로 `/predict` 로직을 다시 호출하여 예측을 재실행하고 사용자에게 최종 결과를 보냅니다.
        4.  재실행 후, `pending_prediction` 상태를 삭제합니다.

## 3. 과제 목록 (TODO)

- [ ] **1단계: `predict.py` 수정**
    - [ ] **1.1:** `predict_command`가 API로부터 "데이터 부족" 오류를 감지하도록 수정
    - [ ] **1.2:** 오류 감지 시, 사용자에게 확인 버튼(Yes/No)이 포함된 메시지 전송 로직 구현
    - [ ] **1.3:** `predict_callback_handler` 라는 새로운 콜백 쿼리 핸들러 생성
    - [ ] **1.4:** "Yes"(`predict_after_update_`) 콜백 로직 구현 (안내 메시지 수정, `user_data` 상태 저장, 데이터 업데이트 API 호출)
    - [ ] **1.5:** "No"(`predict_cancel`) 콜백 로직 구현 (안내 메시지 수정)
- [ ] **2단계: 알림 처리 및 자동 재예측**
    - [ ] **2.1:** `bot/main.py`에 작업 완료 알림을 감지할 `MessageHandler` 추가
    - [ ] **2.2:** 알림 메시지를 파싱하여 `pending_prediction` 상태 확인
    - [ ] **2.3:** 상태가 존재할 경우, 저장된 종목명으로 예측 프로세스를 다시 호출하는 로직 구현
- [ ] **3단계: 문서화**
    - [ ] **3.1:** `docs/features/enhanced_prediction_flow.md` 파일 생성
    - [ ] **3.2:** 해당 파일에 새로운 기능의 목표, 로직 흐름, 구현 상세 내용 문서화
