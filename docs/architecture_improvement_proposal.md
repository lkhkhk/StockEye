# 아키텍처 개선 제안: 명시적 메시지 라우팅 도입

- **제안 일자**: 2025-09-05
- **논의 참여자**: 사용자, AI 어시스턴트

## 현행 아키텍처 (Implicit Routing)

현재 봇의 메시지 처리 구조는 `python-telegram-bot` 라이브러리의 기본 핸들러 체인 방식을 따르고 있습니다.

- **동작 방식**: 여러 핸들러(`CommandHandler`, `MessageHandler`, `CallbackQueryHandler` 등)를 우선순위 그룹에 따라 등록하면, 라이브러리가 수신된 업데이트(메시지)의 유형을 파악하여 등록된 핸들러 체인을 순차적으로 통과시키며 처리할 핸들러를 찾습니다.
- **장점**: 간단한 명령어 기반의 봇을 신속하게 개발할 수 있습니다.
- **한계점**:
    - **암묵적 처리**: 메시지 처리 흐름이 명시적이지 않고 라이브러리 내부에 숨겨져 있어, 복잡한 로직을 디버깅하기 어렵습니다.
    - **핸들러 간 충돌**: 기능이 많아지면 유사한 조건의 핸들러(특히 모든 텍스트를 처리하는 `MessageHandler`나 대화 상태를 관리하는 `ConversationHandler`) 간에 충돌이 발생하여 예상치 못한 동작의 원인이 될 수 있습니다. (이번 `predict` 버그가 대표적인 사례)
    - **상태 의존성**: `ConversationHandler`와 같이 특정 '상태'에 강하게 의존하는 경우, 해당 상태가 비정상적으로 종료되지 않으면 다른 모든 핸들러를 차단하는 문제가 발생할 수 있습니다.

## 제안 아키텍처 (Explicit Routing)

사용자께서 제안하신 아키텍처는, 웹 프레임워크의 '라우터'와 유사한 '메시지 브로커'를 봇 내부에 명시적으로 구현하는 방식입니다.

- **개념도**:
  ```
  [Telegram Update] -> [Master Handler (Message Broker)] -> [Identifier Check] -> [Specific Handler (predict, alert...)]
  ```

- **동작 방식**:
    1.  모든 종류의 업데이트를 단 하나의 마스터 핸들러(메시지 브로커)가 수신합니다.
    2.  브로커는 업데이트의 내용(예: `callback_data`의 접두어 `predict:`, `alert:`)에서 해당 메시지를 어느 기능이 처리해야 하는지를 나타내는 **명시적인 서비스 구분자(Identifier)**를 파악합니다.
    3.  구분자에 따라, 메시지를 사전에 매핑된 특정 핸들러(예: `predict_handler`, `alert_handler`)에게 직접 전달하여 처리하도록 합니다.

- **기대 효과**:
    - **명확성 및 디버깅 용이성**: 메시지의 처리 경로가 중앙의 브로커에 의해 명확하게 결정되므로, 시스템의 동작을 이해하고 추적하기 매우 쉬워집니다.
    - **충돌 원천 방지**: 핸들러의 등록 순서나 우선순위에 의존하지 않고, 명시적인 라우팅 규칙에 따라 동작하므로 핸들러 간의 충돌 가능성이 원천적으로 사라집니다.
    - **확장성 및 유지보수성**: 새로운 기능을 추가할 때, 다른 기능에 미칠 영향을 걱정할 필요 없이 새로운 서비스 구분자와 핸들러만 브로커에 등록하면 되므로, 시스템의 확장과 유지보수가 용이해집니다.

## 결론

현행 방식은 초기 개발 속도에 이점이 있었으나, 현재와 같이 기능이 고도화된 시점에서는 여러 한계점을 드러내고 있습니다. 장기적인 안정성과 유지보수성을 위해, 제안된 **명시적 메시지 라우팅 아키텍처**로의 전환을 적극적으로 고려할 필요가 있습니다.

이는 상당한 규모의 리팩토링이 필요한 작업이므로, 별도의 개발 주기를 할당하여 프로젝트의 코어 아키텍처 개선 작업으로 진행하는 것을 권장합니다.
