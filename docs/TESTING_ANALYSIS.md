# 테스트 코드 분석 및 개선 계획

## 1. 개요

프로젝트의 테스트는 `api`와 `bot` 두 서비스로 나뉘어 있으며, `pytest`를 기반으로 작성되었습니다. `api` 테스트는 DB 상호작용을 테스트하기 위해 `sqlite` 인메모리 DB를 사용하며, `bot` 테스트는 `unittest.mock`을 사용하여 텔레그램 API 및 내부 API 호출을 모의(mock)합니다.

**전반적으로 테스트 구조는 잘 잡혀있으나, 커버리지, 일관성, 유지보수성 측면에서 개선할 점이 보입니다.**

## 2. 서비스별 상세 분석

### 2.1. API 서비스 (`src/api/tests/`)

**장점:**

*   **`conftest.py`를 통한 체계적인 테스트 환경:** `sqlite` 인메모리 DB를 사용하여 테스트마다 독립적인 DB 환경을 제공하고, 테스트 후 자동으로 롤백하여 테스트 간의 격리를 보장합니다. 이는 매우 좋은 패턴입니다.
*   **E2E 시나리오 테스트:** `test_e2e_scenario.py`는 사용자 등록부터 주요 기능(관심 종목, 알림, 예측, 거래)을 순차적으로 실행하며 전체적인 흐름을 검증합니다. 이는 시스템의 통합적인 안정성을 확인하는 데 매우 효과적입니다.
*   **잡(Job) 테스트:** `test_main_jobs.py`와 `test_stock_service.py`는 스케줄러에 의해 실행되는 백그라운드 작업의 예외 처리를 테스트합니다. 특정 기능(가격 조회, DB 저장)에서 오류가 발생했을 때 전체 작업이 중단되지 않고 계속 진행되는지를 검증하는 중요한 테스트입니다.
*   **라우터별 테스트 파일 분리:** `test_api_admin.py`, `test_api_alerts.py` 등 각 라우터(기능)별로 테스트 파일이 분리되어 있어 관리가 용이합니다.

**개선점:**

*   **테스트 커버리지 부족:**
    *   `user.py`, `stock_master.py`, `notification.py` 등 일부 라우터에 대한 테스트가 존재하지 않습니다. 모든 API 엔드포인트에 대한 최소한의 성공/실패 테스트가 필요합니다.
    *   `predict.py` 라우터는 `user_id`를 받아 예측 이력을 저장하는 로직이 있으나, `test_api_predict.py`에서는 `user_id` 없이 호출하는 케이스만 테스트하고 있습니다. 인증된 사용자가 요청하는 시나리오에 대한 테스트가 누락되었습니다.
*   **`async/await` 사용 불일치:** FastAPI는 비동기 프레임워크이지만, `TestClient`를 사용한 테스트 코드는 모두 동기적으로 작성되었습니다. `TestClient`는 내부적으로 `asyncio.run`을 사용하여 비동기 코드를 실행해주므로 문제는 없지만, 비동기 테스트 클라이언트인 `httpx.AsyncClient`를 사용하면 `async def test_...`와 같이 비동기적으로 테스트를 작성할 수 있어 코드의 일관성을 높일 수 있습니다.
*   **API 명세(데이터 타입) 검증 미흡:**
    *   대부분의 테스트가 `response.status_code == 200`과 일부 키의 존재 여부만 확인합니다. 응답 본문의 전체적인 구조와 각 필드의 데이터 타입(e.g., `id`는 `int`, `name`은 `str`)까지 검증하는 것이 더 안전합니다. Pydantic 모델을 활용하여 응답 데이터의 유효성을 검증할 수 있습니다.
*   **인증/인가 테스트 부족:** `test_api_admin.py`에서는 "실제로는 로그인 과정 모킹 필요"라고 주석 처리되어 있듯이, 특정 권한(e.g., admin)이 필요한 API에 대해 권한이 없는 사용자가 접근했을 때 403 Forbidden 에러가 발생하는지와 같은 테스트가 필요합니다.

### 2.2. Bot 서비스 (`src/bot/tests/`)

**장점:**

*   **`AsyncMock`을 활용한 비동기 테스트:** `test_alert_handler.py`는 `AsyncMock`을 사용하여 `update.message.reply_text`와 같은 비동기 함수들을 효과적으로 모의하고, `await` 키워드를 사용하여 실제 비동기 코드처럼 테스트를 작성했습니다. 이는 매우 훌륭합니다.
*   **실제 명령어 형식의 테스트:** `/set_price [종목코드] [가격] [조건]`과 같이 실제 사용자가 입력하는 명령어 형식을 `context.args`로 모의하여 테스트를 수행합니다. 이는 실제 사용 시나리오를 잘 반영합니다.
*   **API 호출 모의:** `session.post`, `session.get` 등을 `patch`하여 `api` 서비스의 응답을 모의함으로써 `bot` 서비스 로직을 독립적으로 테스트할 수 있습니다.
*   **다양한 시나리오 테스트:** `test_alert_handler.py`는 성공, 잘못된 인자, API 실패 등 다양한 케이스에 대해 테스트를 작성하여 핸들러의 안정성을 높였습니다.

**개선점:**

*   **테스트 커버리지 심각한 부족:**
    *   `admin.py`, `help.py`, `history.py`, `natural.py`, `predict.py`, `register.py`, `start.py`, `symbols.py`, `trade.py`, `watchlist.py` 등 **대부분의 핸들러에 대한 테스트가 없습니다.**
    *   `test_bot_basic.py`와 `test_bot_history.py`는 단순히 `main.py`를 실행해보는 수준으로, 실제 기능에 대한 테스트라고 보기 어렵습니다.
*   **테스트의 일관성 및 구조:**
    *   `test_bot_admin.py`는 `unittest.mock`의 `MagicMock`과 `patch`를 사용했지만, `test_alert_handler.py`처럼 `AsyncMock`을 사용하지 않아 비동기 코드에 대한 테스트가 정확하지 않을 수 있습니다. 모든 비동기 핸들러 테스트는 `AsyncMock`을 사용하는 `pytest.mark.asyncio` 스타일로 통일하는 것이 좋습니다.
*   **콜백 쿼리(Callback Query) 테스트 부재:** `alert_add` 핸들러는 `InlineKeyboardMarkup`을 사용하여 버튼을 생성하는데, 이 버튼을 눌렀을 때 발생하는 콜백 쿼리를 처리하는 로직에 대한 테스트가 없습니다. `update.callback_query`를 모의하여 콜백 데이터가 올바르게 처리되는지 검증해야 합니다.

### 2.3. Common 모듈

*   **테스트 없음:** `src/common/` 디렉토리에는 `tests` 폴더 자체가 존재하지 않습니다. `db_connector.py`, `http_client.py` 등 핵심 공통 모듈에 대한 단위 테스트가 반드시 필요합니다. 특히 `http_client.py`의 재시도 로직은 독립적인 테스트를 통해 다양한 네트워크 오류 상황에서 의도대로 동작하는지 검증해야 합니다.

## 3. 종합 결론 및 권장 사항

**"현재 테스트 코드는 프로젝트의 핵심 기능 일부에 대한 기본적인 검증은 수행하고 있으나, 전체적인 기능 커버리지와 테스트의 깊이, 일관성 측면에서 크게 부족하여 시스템의 안정성을 보장하기에는 미흡한 상태입니다."**

**구체적인 개선 권장 사항:**

1.  **테스트 커버리지 확대 (가장 시급):**
    *   **API:** 테스트가 없는 모든 라우터(`user`, `stock_master`, `notification` 등)에 대한 테스트 파일을 생성하고, 각 엔드포인트별로 최소한 "성공"과 "잘못된 요청(4xx)" 케이스에 대한 테스트를 추가합니다.
    *   **Bot:** 테스트가 없는 모든 핸들러(`predict`, `watchlist`, `trade` 등)에 대한 테스트 파일을 `test_alert_handler.py`와 같은 형식으로 작성합니다.
    *   **Common:** `src/common/tests` 디렉토리를 생성하고 `http_client`의 재시도 로직, `dart_utils`의 데이터 파싱 로직 등에 대한 단위 테스트를 추가합니다.

2.  **테스트 품질 향상:**
    *   **API 응답 검증 강화:** Status code만 확인하지 말고, Pydantic 모델이나 직접 만든 스키마를 사용하여 응답 본문의 전체 구조와 데이터 타입을 상세하게 검증합니다.
    *   **인증/인가 테스트 추가:** `@pytest.mark.parametrize`를 사용하여 "관리자", "일반 사용자", "미로그인 사용자" 등 다양한 역할에 따른 접근 제어(성공/403 Forbidden)를 테스트합니다.
    *   **Bot 콜백 쿼리 테스트:** `update.callback_query`를 `AsyncMock`으로 만들고, `data` 속성을 설정하여 버튼 클릭 시 발생하는 로직을 테스트합니다.

3.  **테스트 코드 일관성 및 리팩토링:**
    *   **비동기 테스트 통일:** 모든 `bot` 핸들러 테스트는 `pytest.mark.asyncio`와 `AsyncMock`을 사용하는 스타일로 통일합니다.
    *   **테스트 헬퍼 함수 도입:** `api` 테스트에서 사용자 생성 및 로그인, 인증 헤더를 가져오는 코드가 여러 파일에 중복되어 있습니다. 이를 `conftest.py`나 별도의 `test_utils.py` 파일에 헬퍼 함수로 만들어 재사용성을 높입니다.
