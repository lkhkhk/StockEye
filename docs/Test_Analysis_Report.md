# StocksEye 테스트 분석 및 해결 계획 보고서 (2025-08-04)

## 1. 최종 요약

**심각한 연동 버그 및 E2E 테스트 부재**

- **핵심 기능 대부분 미작동:** `alert`, `history`, `trade`, `watchlist` 등 사용자 개인화 데이터가 필요한 핵심 기능 대부분이 Bot-API 간 **사용자 식별 및 인증 방식 불일치**로 인해 현재 전혀 동작하지 않는 상태입니다. 봇은 `telegram_id`를 사용하지만, API는 `user_id`와 `JWT 토큰`을 요구하여 발생하는 문제입니다.
- **E2E 테스트 부재가 근본 원인:** 이 심각한 버그들이 사전에 발견되지 않은 가장 큰 원인은 **End-to-End(E2E) 테스트의 부재**입니다. 각 모듈(Bot, API)의 단위/통합 테스트만으로는 연동 과정의 문제를 확인할 수 없었습니다.

## 2. 🐞 버그별 상세 분석 및 해결 방안

### 2.1. [치명적] 사용자 데이터 연동 기능 전체 미작동

- **대상 기능:** `/alert`, `/history`, `/trade`, `/watchlist` 관련 모든 명령어
- **현상:** 해당 명령어 실행 시, API가 인증/사용자 식별 오류를 반환하여 기능이 실패합니다.
- **근본 원인:** Bot은 `telegram_id`를 API로 보내지만, API 엔드포인트는 `user_id`와 `JWT` 토큰 기반의 인증을 요구합니다.
- **해결 방안:**
    1.  **아키텍처 변경:** 봇과 API 간의 통신을 위한 **내부용(internal) API 라우터**를 신설하여, `telegram_id` 기반의 사용자 식별 및 자동 등록 로직을 중앙에서 처리합니다. 이를 통해 기존의 JWT 인증 방식(웹/앱용)과 봇용 인증 방식을 명확히 분리합니다.
    2.  **단계별 수정 절차:**
        -   **API 스키마 수정:** 각 기능의 `Create` 스키마(`PriceAlertCreate` 등)에 `telegram_id: int` 필드를 추가하고, 불필요한 사용자 정보 필드를 제거합니다.
        -   **API 라우터 수정:**
            -   기존 엔드포인트에서 `Depends(get_current_active_user)` 의존성을 제거합니다.
            -   요청 본문(body)에서 `telegram_id`를 받아옵니다.
            -   `UserService`를 사용하여 `telegram_id`로 사용자를 조회(`get_user_by_telegram_id`)하고, 없으면 신규 생성(`create_user_from_telegram`)합니다.
            -   조회/생성된 `user.id`를 사용하여 각 서비스(`PriceAlertService` 등)를 호출합니다.
        -   **Bot 핸들러 수정:** API 호출 시 페이로드에 `telegram_id`를 포함하도록 수정합니다.
    3.  **검증 방안:** 각 기능 수정 완료 후, **반드시 E2E 테스트를 작성**하여 실제 봇과 API가 연동되는 전체 흐름을 검증합니다. (예: `/set_alert` -> API 알림 생성 -> `/alert_list` -> 생성된 알림 확인 -> `/alert_remove` -> 알림 삭제 확인)

### 2.2. [심각] 자연어 처리 기능 미작동

- **대상 기능:** `natural` (자연어 처리) 핸들러
- **현상:** 자연어 입력 시 `TypeError`가 발생하며 기능이 실패합니다.
- **근본 원인:** `natural.py` 핸들러는 `/symbols/search` API의 응답을 `list`로 예상하지만, 실제 API는 페이지네이션을 위해 `dict` (`{"items": [...]}`) 형태로 응답합니다.
- **해결 방안:**
    1.  **파일:** `src/bot/handlers/natural.py`
    2.  **수정:** API 응답을 받은 직후, `data = await response.json()` 라인 다음에 `stocks = data.get('items', [])` 와 같이 실제 종목 리스트를 추출하는 코드를 추가합니다.
    3.  **검증:** E2E 테스트를 통해 자연어 입력 시 종목 검색 및 예측/상세 정보 조회가 정상적으로 수행되는지 확인합니다.

### 2.3. [기능 누락] 예측 이력 미저장

- **대상 기능:** `/predict`, `/natural`
- **현상:** 주가 예측을 수행해도 사용자별 예측 이력이 DB에 저장되지 않습니다.
- **근본 원인:** Bot 핸들러가 `/predict` API 호출 시, 이력 저장에 필요한 `user_id` (또는 `telegram_id`)를 전달하지 않습니다.
- **해결 방안:**
    1.  **파일:** `src/bot/handlers/predict.py`, `src/bot/handlers/natural.py`
    2.  **수정:** `/predict` API를 호출하는 모든 `session.post`의 `json` 페이로드에 `"user_id": user.id` (또는 `"telegram_id": user.id`)를 추가합니다. (`user` 객체는 `update.effective_user`로부터 얻습니다.)
    3.  **검증:** E2E 테스트를 통해 예측 명령어 실행 후, DB의 `prediction_history` 테이블에 해당 사용자의 예측 기록이 올바르게 저장되었는지 확인합니다.

### 2.4. [개선] 기타 테스트 및 리팩토링

- **대상:** `/register`, `/start`, `admin` 라우터, `predict` 서비스 등
- **현상:** 단위 테스트 부재, 기능과 명령어 이름 불일치, 코드 중복 등의 문제가 있습니다.
- **해결 방안:**
    - **단위 테스트 작성:** `start.py`, `history.py` 핸들러 및 `admin.py` API 라우터에 대한 단위 테스트를 신규 작성합니다.
    - **명령어 이름 변경:** `/register`를 `/notify_on`, `/unregister`를 `/notify_off`으로 변경하여 기능의 명확성을 높이는 것을 검토하고, 관련 코드 및 문서를 모두 수정합니다.
    - **코드 리팩토링:** `predict_service.py`의 중복된 예측 로직을 단일 함수로 통합하여 유지보수성을 개선합니다.

## 3. 🤖 봇 명령어별 상세 현황

| 명령어 | 기능 | Bot | API | E2E | 종합 평가 및 핵심 문제 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| `/register` | 글로벌 알림 설정 | ✅ | ✅ | ❌ | **양호.** 단, 명령어 이름 변경 고려. E2E 테스트 필요. |
| `/alert` | 종목별 알림 | ⚠️ | ⚠️ | ❌ | **심각 (미작동).** Bot-API 인증 방식 불일치. |
| `/admin` | 관리자 기능 | ✅ | ✅ | ❌ | **양호.** API 단위 테스트 및 E2E 테스트 필요. |
| `/help` | 도움말 | ✅ | N/A | ❌ | **양호.** E2E 테스트 추가 권장. |
| `/history` | 거래/예측 내역 | ⚠️ | ⚠️ | ❌ | **심각 (미작동).** Bot-API 사용자 식별자/인증 방식 불일치. Bot 단위 테스트 부재. |
| `/natural` | 자연어 처리 | ⚠️ | ✅ | ❌ | **심각 (미작동).** API 응답 형식 불일치로 인한 `TypeError`. 예측 이력 `user_id` 누락. |
| `/predict` | 주가 예측 | ⚠️ | ✅ | ❌ | **부분적 동작.** 예측 이력 `user_id` 누락. API 통합 테스트 부재. |
| `/start` | 시작 메시지 | ✅ | N/A | ✅ | **양호.** Bot 단위 테스트 부재. |
| `/symbols` | 종목 검색 | ✅ | ✅ | ❌ | **양호.** E2E 테스트 추가 권장. |
| `/trade` | 모의 거래 | ⚠️ | ⚠️ | ❌ | **심각 (미작동).** Bot-API 사용자 식별자/인증 방식 불일치. |
| `/watchlist` | 관심 종목 | ⚠️ | ⚠️ | ❌ | **심각 (미작동).** Bot-API 사용자 식별자/인증 방식 불일치. |

*✅: 정상 / ⚠️: 문제 있음 / ❌: 누락 / N/A: 해당 없음*