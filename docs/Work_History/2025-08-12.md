## 봇 관리자 명령어(`update_master`) 인증/인가 오류 해결 (2025-08-12)

*   **목표:** 텔레그램 봇의 관리자 명령어가 API 서버로부터 404, 403 등 다양한 오류를 반환하며 실패하는 문제를 근본적으로 해결하고, 안정적인 서비스 간 인증/인가 체계를 구축합니다.

*   **문제 해결 과정:**
    1.  **초기 문제 (404 Not Found):**
        *   **원인:** Bot이 호출하는 API 엔드포인트(`POST /admin/update_master`)가 `src/api/routers/admin.py`에 구현되어 있지 않았습니다.
        *   **해결:** 해당 라우터 파일에 누락된 엔드포인트 로직을 추가했습니다.

    2.  **2차 문제 (404 Not Found):**
        *   **원인:** API의 모든 라우터에는 `/api/v1` 전역 접두사가 적용되지만, Bot이 API를 호출할 때 이 접두사를 누락하여 잘못된 URL로 요청하고 있었습니다.
        *   **해결:** `src/bot/handlers/admin.py`의 API 호출 URL에 `/api/v1`을 포함하도록 수정했습니다.

    3.  **3차 문제 (403 Forbidden):**
        *   **원인:** URL 문제는 해결되었으나, Bot이 API의 보호된 관리자 엔드포인트를 호출할 때 아무런 인증 정보(JWT 토큰)를 보내지 않아 API가 접근을 거부했습니다.
        *   **분석:** Bot은 `telegram_id`로 관리자를 식별하지만, API는 `JWT 토큰`으로 인가(Authorization)를 처리하는 근본적인 불일치가 있었습니다.

    4.  **아키텍처 보완 및 최종 해결:**
        *   **사용자 자동 등록 및 관리자 역할 부여:**
            *   사용자가 봇과 처음 상호작용할 때, DB에 해당 사용자가 없으면 자동으로 등록하는 `@ensure_user_registered` 데코레이터를 `src/bot/decorators.py`에 구현했습니다.
            *   `src/api/services/user_service.py`를 수정하여, 새로 등록되는 사용자의 `telegram_id`가 환경변수 `TELEGRAM_ADMIN_ID`와 일치하면 `role`을 `admin`으로 자동 설정하도록 변경했습니다.
        *   **Bot 전용 토큰 발급 엔드포인트 신설:**
            *   Bot이 `telegram_id`를 이용해 해당 사용자의 JWT 토큰을 발급받을 수 있는 `POST /api/v1/auth/bot/token` 엔드포인트를 `src/api/routers/auth.py`에 신설했습니다.
            *   이 엔드포인트는 Bot과 API만 아는 비밀 키(`BOT_SECRET_KEY`)를 `X-Bot-Secret-Key` 헤더로 받아야만 호출할 수 있도록 보호됩니다.
        *   **Bot 핸들러 수정:**
            *   `src/bot/handlers/admin.py`의 모든 관리자 명령어 핸들러를 수정했습니다.
            *   핸들러는 API 호출 전, 먼저 `/auth/bot/token`을 호출하여 현재 명령을 내린 사용자의 JWT 토큰을 발급받습니다.
            *   그 후, 발급받은 토큰을 `Authorization: Bearer <token>` 헤더에 담아 원래 목적지(예: `/admin/update_master`)에 요청을 보냅니다.

    5.  **순환 참조 및 기타 오류 해결:**
        *   위 아키텍처를 구현하는 과정에서 다수의 순환 참조(`Circular Import`) 오류와 `await` 키워드 오용 오류가 발생했습니다.
        *   `jwt_handler.py`, `auth.py`, `admin.py` 등의 파일을 여러 차례 수정하여 모든 오류를 해결하고, `docker compose up`이 정상적으로 실행되도록 조치했습니다.

*   **결과:** 복잡하게 얽혀있던 서비스 간 인증/인가 문제를 최종적으로 해결했습니다. 이제 관리자 사용자는 봇을 통해 관리자 명령어를 정상적으로 실행할 수 있습니다.
