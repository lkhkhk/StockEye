# StockEye 개발 작업 기록 (2025-08-29)

## 1. 개요
본 문서는 2025년 8월 29일 진행된 StockEye 프로젝트 개발 작업의 진행 상황, 발생한 문제점, 해결 과정 및 현재 상태를 기록합니다. 주요 목표는 서비스 아키텍처 리팩토링 후 발생한 테스트 오류를 해결하고 시스템 안정성을 확보하는 것입니다.

## 2. 작업 내용 및 진행 상황

### 2.1. 초기 분석 및 계획 수립
- `TODO.md` 및 기존 작업 로그(`docs/worklogs/`)를 통해 프로젝트의 현재 진행 상황(아키텍처 재설계 및 `worker` 서비스 도입)과 다음 계획을 파악했습니다.
- `api`와 `bot` 서비스 간의 순환 의존성 해결을 위한 `worker` 서비스 도입 및 `src/common` 모듈 분리 작업이 진행 중임을 확인했습니다.

### 2.2. `worker` 서비스 단위 테스트 디버깅 및 안정화 (완료)

#### 2.2.1. `ImportError` 해결
- **문제:** `worker` 서비스 단위 테스트(`test_main_jobs.py`, `test_scheduler.py`)에서 `src.api` 경로를 참조하는 `ImportError` 발생.
- **원인:** `api` 서비스의 일부 서비스 및 모델 파일이 `src/common`으로 이동되었으나, 테스트 코드가 이를 반영하지 못함.
- **해결:** `test_main_jobs.py` 및 `test_scheduler.py`의 임포트 경로를 `src.common`으로 수정.

#### 2.2.2. `test_listener.py` 디버깅 (복잡한 비동기/Mocking 문제)
- **문제:** `test_listener.py` 테스트 실행 시 `TypeError` 발생 및 테스트 멈춤(hang) 현상.
- **해결 과정:**
    - **"최소 단위 임시 테스트" 전략 도입:** `docs/6.Troubleshooting.md`에 해당 디버깅 전략을 문서화하고, 이를 활용하여 문제의 원인을 단계적으로 격리.
    - **`main.py` 버그 수정:** `src/worker/main.py`의 `notification_listener` 함수 내 `pubsub = r.pubsub()` 라인에 `await` 누락(`pubsub = await r.pubsub()`) 버그 발견 및 수정.
    - **`test_listener.py` Mocking 개선:**
        - `mock_redis_conn.close` 메서드가 `awaitable`하도록 `AsyncMock`으로 명시적 설정.
        - `redis.from_url` 호출 시 `REDIS_HOST` 환경 변수를 사용하도록 테스트 어설션 수정.
        - `main.py`의 로그 메시지(`"Notification listener task cancelled."`)에 `[Listener]` 접두사가 누락되어 테스트 어설션이 실패하던 문제 해결 (로그 메시지 수정).
        - `mock_pubsub.get_message`의 `side_effect`에 `None`이 포함되어 무한 루프를 유발하던 문제 해결. `notification_listener`를 `asyncio.Task`로 생성하고, 메시지 처리 후 `task.cancel()`을 명시적으로 호출하여 테스트 종료.
    - **Docker 환경 문제 해결:** 파일 변경사항이 컨테이너에 반영되지 않던 문제 해결을 위해 `docker-compose.yml`의 `stockeye-worker` 서비스 `command`에 `--reload` 옵션 추가 및 서비스 재빌드/재생성(`docker compose up -d --build`).
- **결과:** 모든 `worker` 서비스 단위 테스트가 성공적으로 통과.

### 2.3. `api` 서비스 단위 테스트 디버깅 및 안정화 (완료)

#### 2.3.1. `test_user_service.py` 디버깅
- **문제:** `ImportError: cannot import name 'create_user' from 'src.api.services.user_service'` 발생.
- **원인:** `create_user`, `get_user_by_username`, `authenticate_user`, `get_user_stats`와 같은 함수들이 코드베이스에서 제거되었거나 다른 파일로 이동되었음(`src/` 디렉토리 전체 검색 결과 확인). `test_user_service.py`가 더 이상 존재하지 않는 기능을 테스트하고 있었음.
- **해결:** `test_user_service.py`에서 해당 함수들의 임포트 및 관련 테스트 케이스를 모두 삭제. `UserService` 클래스 메서드에 대한 테스트만 유지.
- **결과:** `test_user_service.py` 통과.

#### 2.3.2. `test_api_admin.py` 디버깅 및 리팩토링 (완료)
- **문제:** `test_api_admin.py` 실행 시, 특정 테스트에서 원인 불명의 멈춤(hang) 현상 발생.
- **디버깅 과정:**
    1.  **"최소 단위 임시 테스트" 전략 적용:** `TestClient` 초기화, 의존성 주입 등 문제 발생 의심 지점을 격리하는 작은 테스트를 반복 실행하며 원인 추적.
    2.  **`patch`와 `dependency_overrides` 충돌 확인:** FastAPI의 의존성(`Depends`)을 `unittest.mock.patch`로 Mocking할 때, `TestClient`의 내부 동작과 충돌하여 멈춤 현상이 발생하는 것을 확인.
    3.  **사용자 피드백으로 최종 원인 특정:** 사용자께서 "종목 리스트가 나오다가 멈춘다"는 결정적인 로그를 제공해주심. 이를 통해 `test_update_master_success` 테스트에서 `StockService` Mocking이 실패하여 실제 코드가 호출되고 있음을 확인함.
- **근본 원인:** FastAPI 의존성을 Mocking할 때, 범용적인 `patch`를 사용하면 프레임워크의 라이프사이클과 충돌하여 불안정한 동작을 유발할 수 있음.
- **해결책:**
    1.  **`dependency_overrides`로 통일:** FastAPI 의존성(`get_db`, `get_stock_service` 등)을 Mocking하는 모든 코드를 FastAPI의 공식 테스트 방식인 `app.dependency_overrides`를 사용하도록 전면 리팩토링함.
    2.  **`patch`의 올바른 사용:** `os.environ`, `httpx.AsyncClient` 등 FastAPI 의존성이 아닌 대상을 Mocking하는 코드는 `patch`를 그대로 유지하여, 각 도구를 용도에 맞게 사용하도록 정리함.
    3.  **안전장치 추가:** `pytest-timeout` 패키지를 설치하고, 문제가 됐던 테스트에 `@pytest.mark.timeout(10)`을 추가하여 향후 유사 문제 발생 시 테스트가 멈추지 않고 실패하도록 조치함.
- **결과:** `test_api_admin.py`의 모든 테스트가 안정적으로 통과함.

## 3. 현재 상태
- 모든 `worker` 및 `api` 서비스의 단위 테스트가 **통과** 상태입니다.
- `api` 테스트 안정화 과정에서 발견된 `patch`와 `dependency_overrides`의 올바른 사용법을 `docs/6.Troubleshooting.md`에 상세히 **문서화**했습니다.
- 향후 유사 문제 재발 방지를 위해, 디버깅에 사용된 임시 엔드포인트와 비활성화된 테스트는 코드에 그대로 **유지**했습니다.

## 4. 다음 계획
- `TODO.md`의 `Phase 7` 아키텍처 리팩토링 검증 절차에 따라, `bot` 서비스의 전체 테스트를 실행하여 시스템 전반의 안정성을 확인합니다.
- 모든 서비스의 테스트가 안정적으로 통과하면, `Phase 4`의 **테스트 커버리지 100% 달성**을 위한 작업을 시작합니다.