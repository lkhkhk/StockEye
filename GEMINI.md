# Gemini CLI Agent 지시사항

이 문서는 Gemini CLI Agent가 프로젝트 작업을 수행하면서 받은 주요 지시사항과 작업 원칙을 관리합니다.

상세한 작업 기록은 [docs/history/WORK_LOG.md](docs/history/WORK_LOG.md) 파일을 참고해주세요.

## 1. 작업 원칙 및 워크플로우

### 1.1. 안정성 강화를 위한 개발 워크플로우

모든 코드 수정 작업은 다음의 5단계 워크플로우를 **반드시** 준수하여 안정성을 최우선으로 확보합니다.

1.  **사전 분석 및 영향도 평가 (Pre-analysis & Impact Assessment)**
    *   코드 수정 전, `read_file`, `search_file_content` 등을 통해 변경할 코드와 관련된 모든 부분을 파악합니다.
    *   특히, 해당 코드를 호출하는 다른 함수나 클래스, 관련 테스트 코드를 모두 확인하여 변경으로 인해 영향을 받을 수 있는 범위를 명확히 정의합니다.

2.  **테스트 주도 변경 (Test-Driven Modification)**
    *   변경 사항을 검증할 수 있는 테스트 코드가 존재하는지 확인합니다.
    *   만약 테스트 코드가 없다면, **기능 수정 전에 테스트 코드를 먼저 작성**하여 안전장치를 확보합니다.
    *   기존 테스트가 있다면, 변경 후에도 해당 테스트가 통과되어야 함을 인지하고, 필요시 테스트 코드도 함께 수정합니다.

3.  **코드 수정 (Code Modification)**
    *   사전 분석과 테스트 계획에 따라 코드를 수정합니다.
    *   `replace` 도구 사용 시, `old_string`과 `new_string`의 정확성에 만전을 기하고, 의도치 않은 변경이 발생하지 않도록 최소한의 범위로, 하지만 명확하게 수정합니다.

4.  **단계적 검증 (Staged Verification) - 중요**
    *   **4.1. 단위 테스트:** 코드 수정 직후, `docker compose exec [service] pytest [수정한 파일의 테스트 경로]` 명령으로 **수정된 부분과 직접적으로 관련된 테스트만 먼저 실행**하여 1차 검증을 수행합니다. (예: `pytest tests/test_api_admin.py`)
    *   **4.2. 전체 테스트:** 단위 테스트가 통과하면, `docker compose exec [service] pytest` 명령으로 해당 서비스의 **전체 테스트**를 실행하여 수정 사항이 다른 기능에 예기치 않은 문제를 일으키지 않았는지(회귀 오류) 확인합니다.
    *   **4.3. 서비스 재기동 및 로그 확인:** 전체 테스트를 통과하면, `docker compose up -d --build`로 서비스를 재시작하고, **즉시 `docker compose logs [service]`를 실행**하여 기동 중 에러가 없는지 반드시 확인합니다.

5.  **최종 확인 및 보고 (Final Confirmation & Reporting)**
    *   모든 검증 절차가 성공적으로 완료되었을 때, 비로소 작업이 완료된 것으로 간주합니다.
    *   `docs/PLAN.MD`에 진행 상황을 업데이트하고 사용자에게 결과를 보고합니다.

### 1.2. 기존 작업 원칙

*   **선행 테스트:** 모든 신규 작업 착수 전, 전체 테스트를 먼저 실행하여 현 시스템의 안정성을 확인합니다.
*   **계획 수립 및 관리:**
    *   진행할 과제에 대한 상세 계획을 수립합니다.
    *   이 계획을 `docs/PLAN.MD` 파일에 To-Do 항목으로 추가하고, 진행 상황에 따라 항상 최신 상태로 업데이트합니다.
*   **문제 해결 전략:** 다수의 테스트 실패 발생 시, 사용자 요청에 따라 **한 번에 한 건의 테스트 실패만 상세 분석하고 해결**합니다. 모든 실패를 동시에 해결하려 하지 않습니다.
*   **개발 워크플로우:**
    1.  신규/변경 기능에 대한 **테스트 코드를 먼저 작성**합니다.
    2.  테스트를 통과하는 기능 코드를 구현합니다.
    3.  `docker compose`를 사용하여 전체 서비스를 다시 빌드하고 재기동합니다.
    4.  컨테이너 내에서 실제 기능을 테스트하여 완료를 확인합니다.
    5.  계획된 작업 단위가 완료되면, 진행 상황을 보고하고 다음 단계 진행에 대한 지시를 기다립니다.
*   **코드 품질 및 구조:**
    *   꼼꼼하고 신중하게 작업하며, 변경 사항이 기존 코드에 미치는 영향을 항상 확인합니다.
    *   기존 프로젝트 구조를 최대한 유지하며, 변경이 필요할 경우 사전에 상세 설명과 함께 문의합니다.
*   **`replace` 도구 사용 지침:**
    *   `replace` 도구 사용 전에는 반드시 `read_file`로 대상 파일의 현재 내용을 읽어옵니다.
    *   `old_string` 인자는 `read_file` 결과에서 변경할 부분을 정확히 복사하여 사용합니다. (공백, 들여쓰기, 줄바꿈 포함)
    *   `old_string`이 짧아 중복될 가능성이 있는 경우, **변경할 코드 블록을 고유하게 식별할 수 있도록 최소 3줄 이상의 충분한 컨텍스트(주변 코드, 주석 등)를 포함**합니다.
    *   여러 번 변경이 필요한 경우 `expected_replacements` 인자를 명시합니다.
    *   **`old_string`이 고유하지 않아 `replace` 도구 사용이 실패할 경우, 해당 코드 블록을 고유하게 식별할 수 있는 더 넓은 범위의 컨텍스트를 `old_string`에 포함하여 재시도합니다.**
*   **`src/common` 모듈 변경 시 주의사항:**
    *   `api`와 `bot` 서비스는 `src/common` 디렉토리를 공유하므로, 이 디렉토리 내의 파일 변경은 두 서비스 모두에 영향을 미칩니다.
    *   `src/common` 파일 변경 시, 해당 변경이 영향을 미치는 모든 `api` 및 `bot` 서비스의 관련 파일을 **동시에, 그리고 일관되게 수정**해야 합니다.
*   **실행 환경:**
    *   `docker compose` 명령어를 사용합니다.
    *   **`docker compose` 명령어에는 컨테이너 이름(`api_service`, `bot_service` 등)이 아닌 서비스 이름(`api`, `bot`)을 사용해야 합니다.**
    *   테스트 코드 작성 및 실행은 각 서비스(`api`, `bot`)의 `tests` 폴더 내에서, 컨테이너 안에서 수행합니다.
    *   파일 삭제 등 권한 문제가 발생할 수 있는 작업은 반드시 컨테이너 내부에서 실행합니다.
*   **커뮤니케이션:**
    *   지시사항을 잊지 않고 반복적인 지시가 발생하지 않도록 합니다.
    *   답변은 한국어로 합니다.